<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>مساعد الحصر</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#e67e22">
    <link rel="icon" type="image/png" href="icon-192.png">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Cairo', sans-serif;
        }
        
        body {
            background-color: #f7faff;
            padding: 10px;
        }
        
        .container {
            max-width: 100%;
            margin: 0 auto;
            padding: 0 10px;
        }
        
        .header {
            background-color: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .title {
            color: #e67e22;
            text-align: center;
            margin-bottom: 15px;
            font-size: 22px;
        }
        
        .controls {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .search-box {
            flex: 1;
            min-width: 150px;
            padding: 8px;
            border: 1px solid #2980b9;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .button {
            background-color: #e67e22;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s;
        }
        
        .button:hover {
            background-color: #f39c12;
        }
        
        .button.import {
            background-color: #27ae60;
        }
        
        .button.import:hover {
            background-color: #2ecc71;
        }
        
        .counter {
            background-color: #2980b9;
            color: white;
            padding: 8px 15px;
            border-radius: 5px;
            font-size: 14px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            background-color: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            font-size: 14px;
        }
        
        th, td {
            padding: 10px;
            text-align: right;
            border-bottom: 1px solid #eee;
        }
        
        th {
            background-color: #34495e;
            color: white;
            font-size: 15px;
        }
        
        tr:hover {
            background-color: #f8f9fa;
        }
        
        .camera-button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
            font-size: 13px;
        }
        
        .camera-button:hover {
            background-color: #2980b9;
        }
        
        .switch-camera-button {
            background-color: #2ecc71;
        }
        
        .switch-camera-button:hover {
            background-color: #27ae60;
        }
        
        #camera-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.9);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .camera-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            background-color: black;
            width: 100vw;
            height: 100vh;
            padding-top: 20px;
            box-sizing: border-box;
        }
        #camera-preview, #overlay {
            width: 90vw;
            max-width: 400px;
            height: 90vw;
            max-height: 400px;
            aspect-ratio: 1;
            object-fit: cover;
            background: #000;
            display: block;
            margin: 0 auto;
            position: relative;
        }
        #overlay {
            position: absolute;
            left: 50%;
            top: 20px;
            transform: translateX(-50%);
            z-index: 10;
            pointer-events: none;
        }
        .camera-controls {
            width: 100vw;
            max-width: 400px;
            display: flex;
            justify-content: space-between;
            gap: 8px;
            margin: 20px auto 0 auto;
            position: static;
            z-index: 20;
        }
        @media (max-width: 480px) {
            #camera-preview, #overlay {
                width: 95vw;
                height: 95vw;
                max-width: 95vw;
                max-height: 95vw;
            }
            .camera-controls {
                max-width: 95vw;
            }
        }

        .camera-controls {
            position: fixed;
            bottom: 20px;
            left: 0;
            right: 0;
            display: flex;
            gap: 10px;
            justify-content: center;
            padding: 10px;
            z-index: 1001;
        }
        
        .camera-button {
            background-color: rgba(52, 152, 219, 0.9);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            transition: background-color 0.3s;
            font-size: 14px;
            font-weight: bold;
            min-width: 100px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }
        
        .camera-button:hover {
            background-color: #2980b9;
        }
        
        .switch-camera-button {
            background-color: rgba(46, 204, 113, 0.9);
        }
        
        .switch-camera-button:hover {
            background-color: #27ae60;
        }
        
        #close-button {
            background-color: rgba(231, 76, 60, 0.9);
        }
        
        #close-button:hover {
            background-color: #c0392b;
        }
        
        .student-name {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: rgba(0,0,0,0.7);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 18px;
            z-index: 1001;
        }
        
        .camera-indicator {
            position: fixed;
            top: 20px;
            left: 20px;
            background-color: rgba(0,0,0,0.7);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 18px;
            z-index: 1001;
        }

        @media (max-width: 768px) {
            .camera-controls {
                bottom: 15px;
                gap: 8px;
            }
            
            .camera-button {
                padding: 8px 15px;
                font-size: 13px;
                min-width: 90px;
            }
            
            .student-name, .camera-indicator {
                font-size: 16px;
                padding: 6px 12px;
                top: 10px;
            }
            
            .camera-indicator {
                left: 10px;
            }
            
            .student-name {
                right: 10px;
            }
        }

        @media (max-width: 480px) {
            .camera-controls {
                bottom: 10px;
                gap: 5px;
            }
            
            .camera-button {
                padding: 6px 12px;
                font-size: 12px;
                min-width: 80px;
            }
        }

        /* إضافة خاصية عكس الصورة للكاميرا الأمامية */
        .front-camera {
            transform: scaleX(-1);
        }
    </style>
    <!-- إضافة مكتبة face-api.js -->
    <script defer src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 class="title">مساعد الحصر</h1>
            <div class="controls">
                <input type="text" class="search-box" placeholder="ابحث عن طالب...">
                <button class="button import" onclick="importExcel()">استيراد ملف Excel</button>
                <button class="button" onclick="downloadImages()">تحميل الصور</button>
                <div class="counter">الصور الملتقطة: <span id="photos-count">0</span></div>
            </div>
        </div>
        
        <table id="students-table">
            <thead>
                <tr>
                    <th>الهوية</th>
                    <th>الاسم</th>
                    <th>الصف</th>
                    <th>الفصل</th>
                    <th>رقم الجوال</th>
                    <th>الصورة</th>
                </tr>
            </thead>
            <tbody>
                <!-- سيتم إضافة الصفوف هنا عن طريق JavaScript -->
            </tbody>
        </table>
    </div>
    
    <div id="camera-modal">
        <div class="camera-container">
            <div class="student-name" id="current-student-name"></div>
            <div class="camera-indicator" id="camera-indicator"></div>
            <video id="camera-preview" autoplay playsinline></video>
            <canvas id="overlay" style="position:absolute; top:0; left:0; z-index:10;"></canvas>
            <div class="camera-controls">
                <button id="capture-button" class="camera-button" onclick="capturePhoto()">التقاط صورة</button>
                <button class="camera-button switch-camera-button" onclick="switchCamera()">تبديل الكاميرا</button>
                <button id="close-button" class="camera-button" onclick="closeCamera()">إغلاق</button>
            </div>
        </div>
    </div>
    
    <script>
        let students = [];
        let capturedPhotos = new Map();
        let stream = null;
        let faceDetectionInterval = null;
        let currentFacingMode = 'user';
        let isSwitchingCamera = false;
        
        // تسجيل Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(registration => {
                        console.log('ServiceWorker registration successful');
                    })
                    .catch(err => {
                        console.log('ServiceWorker registration failed: ', err);
                    });
            });
        }
        
        // دالة استيراد ملف Excel
        function importExcel() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.xlsx, .xls';
            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                try {
                    const data = await readExcelFile(file);
                    students = data;
                    updateTable();
                } catch (error) {
                    alert('حدث خطأ أثناء قراءة الملف: ' + error.message);
                }
            };
            input.click();
        }
        
        // دالة قراءة ملف Excel
        function readExcelFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                        const jsonData = XLSX.utils.sheet_to_json(firstSheet);
                        resolve(jsonData);
                    } catch (error) {
                        reject(error);
                    }
                };
                reader.onerror = reject;
                reader.readAsArrayBuffer(file);
            });
        }
        
        // دالة تحديث الجدول
        function updateTable() {
            const tbody = document.querySelector('#students-table tbody');
            tbody.innerHTML = '';
            
            students.forEach(student => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${student['الهوية'] || ''}</td>
                    <td>${student['الاسم'] || ''}</td>
                    <td>${student['الصف'] || ''}</td>
                    <td>${student['الفصل'] || ''}</td>
                    <td>${student['رقم الجوال'] || ''}</td>
                    <td>
                        <button class="camera-button" onclick="openCamera('${student['الهوية']}', '${student['الاسم']}')">
                            ${capturedPhotos.has(student['الهوية']) ? 'إعادة التقاط' : 'التقاط صورة'}
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
            
            updateCounter();
        }
        
        // دالة تنظيف الموارد
        function cleanupResources() {
            if (stream) {
                stream.getTracks().forEach(track => {
                    track.stop();
                });
                stream = null;
            }
            if (faceDetectionInterval) {
                clearInterval(faceDetectionInterval);
                faceDetectionInterval = null;
            }
            const overlayCanvas = document.getElementById('overlay');
            if (overlayCanvas) {
                const context = overlayCanvas.getContext('2d');
                context.clearRect(0, 0, overlayCanvas.width, overlayCanvas.height);
            }
        }

        // دالة إغلاق الكاميرا
        function closeCamera() {
            cleanupResources();
            document.getElementById('camera-modal').style.display = 'none';
        }

        // دالة للحصول على deviceId الخاص بالكاميرا الخلفية الأساسية
        async function getMainBackCameraId() {
            const devices = await navigator.mediaDevices.enumerateDevices();
            // ابحث عن الكاميرا الخلفية التي لا تحتوي على كلمات wide/ultra/macro في الاسم
            const backCams = devices.filter(d => d.kind === 'videoinput' && d.label.toLowerCase().includes('back'));
            // حاول إيجاد كاميرا لا تحتوي على ultra/macro/wide في الاسم
            let mainBack = backCams.find(d => !/ultra|macro|wide/.test(d.label.toLowerCase()));
            if (!mainBack && backCams.length > 0) mainBack = backCams[0];
            return mainBack ? mainBack.deviceId : null;
        }

        async function openCamera(studentId, studentName) {
            const video = document.getElementById('camera-preview');
            const modal = document.getElementById('camera-modal');
            const cameraIndicator = document.getElementById('camera-indicator');

            try {
                let constraints = {
                    video: {
                        width: { ideal: 640 },
                        height: { ideal: 640 },
                        aspectRatio: { ideal: 1 },
                        frameRate: { ideal: 24 }
                    }
                };

                // إذا كانت الكاميرا الخلفية، حاول اختيار العدسة الأساسية وضبط الزوم
                if (currentFacingMode === 'environment') {
                    const deviceId = await getMainBackCameraId();
                    if (deviceId) {
                        constraints.video.deviceId = { exact: deviceId };
                    } else {
                        constraints.video.facingMode = { exact: 'environment' };
                    }
                    constraints.video.advanced = [{
                        focusMode: 'continuous',
                        exposureMode: 'continuous',
                        whiteBalanceMode: 'continuous',
                        zoom: 1 // إذا كان مدعومًا
                    }];
                } else {
                    constraints.video.facingMode = { exact: 'user' };
                }

                stream = await navigator.mediaDevices.getUserMedia(constraints);
                video.srcObject = stream;
                
                // إضافة أو إزالة الكلاس بناءً على نوع الكاميرا
                if (currentFacingMode === 'user') {
                    video.classList.add('front-camera');
                } else {
                    video.classList.remove('front-camera');
                }

                document.getElementById('current-student-name').textContent = studentName;
                cameraIndicator.textContent = currentFacingMode === 'user' ? '1' : '2';
                modal.style.display = 'flex';
                video.dataset.studentId = studentId;

                video.onloadedmetadata = async () => {
                    const screenSize = Math.min(window.innerWidth, window.innerHeight);
                    const videoSize = Math.min(screenSize * 0.9, 640);
                    
                    video.style.width = `${videoSize}px`;
                    video.style.height = `${videoSize}px`;
                    video.style.objectFit = 'cover';
                };

                video.onplay = async () => {
                    await new Promise(resolve => setTimeout(resolve, 100));

                    if (!video.videoWidth || !video.videoHeight) {
                        console.error('Video dimensions not available.');
                        alert('Video dimensions not available.');
                        closeCamera();
                        return;
                    }

                    try {
                        await faceapi.nets.tinyFaceDetector.loadFromUri('models');
                        startFaceDetection();
                    } catch (modelError) {
                        console.error('Error loading face-api.js models:', modelError);
                        alert('حدث خطأ أثناء تحميل نماذج التعرف على الوجه.');
                        closeCamera();
                    }
                };

            } catch (error) {
                console.error('Error accessing camera:', error);
                alert('حدث خطأ في الوصول إلى الكاميرا: ' + error.name + ' - ' + error.message);
                closeCamera();
            }
        }
        
        async function switchCamera() {
            if (isSwitchingCamera) return;
            isSwitchingCamera = true;

            try {
                if (faceDetectionInterval) {
                    clearInterval(faceDetectionInterval);
                    faceDetectionInterval = null;
                }

                cleanupResources();

                currentFacingMode = currentFacingMode === 'user' ? 'environment' : 'user';
                const video = document.getElementById('camera-preview');

                let constraints = {
                    video: {
                        width: { ideal: 640 },
                        height: { ideal: 640 },
                        aspectRatio: { ideal: 1 },
                        frameRate: { ideal: 24 }
                    }
                };

                if (currentFacingMode === 'environment') {
                    const deviceId = await getMainBackCameraId();
                    if (deviceId) {
                        constraints.video.deviceId = { exact: deviceId };
                    } else {
                        constraints.video.facingMode = { exact: 'environment' };
                    }
                    constraints.video.advanced = [{
                        focusMode: 'continuous',
                        exposureMode: 'continuous',
                        whiteBalanceMode: 'continuous',
                        zoom: 1
                    }];
                } else {
                    constraints.video.facingMode = { exact: 'user' };
                }

                stream = await navigator.mediaDevices.getUserMedia(constraints);
                video.srcObject = stream;

                if (currentFacingMode === 'user') {
                    video.classList.add('front-camera');
                } else {
                    video.classList.remove('front-camera');
                }

                const screenSize = Math.min(window.innerWidth, window.innerHeight);
                const videoSize = Math.min(screenSize * 0.9, 640);
                video.style.width = `${videoSize}px`;
                video.style.height = `${videoSize}px`;
                video.style.objectFit = 'cover';

                document.getElementById('camera-indicator').textContent = currentFacingMode === 'user' ? '1' : '2';

                setTimeout(() => {
                    if (stream) {
                        startFaceDetection();
                    }
                }, 500);

            } catch (error) {
                console.error('Error switching camera:', error);
                alert('حدث خطأ أثناء تبديل الكاميرا');
                closeCamera();
            } finally {
                isSwitchingCamera = false;
            }
        }

        // دالة بدء كشف الوجه
        async function startFaceDetection() {
            const video = document.getElementById('camera-preview');
            const overlayCanvas = document.getElementById('overlay');

            try {
                // استخدم الأبعاد الحقيقية للفيديو وليس أبعاد العنصر المعروض
                const videoWidth = video.videoWidth;
                const videoHeight = video.videoHeight;
                overlayCanvas.width = videoWidth;
                overlayCanvas.height = videoHeight;

                // اجعل الـ overlay فوق الفيديو في نفس المكان
                overlayCanvas.style.width = video.style.width;
                overlayCanvas.style.height = video.style.height;
                overlayCanvas.style.left = video.offsetLeft + 'px';
                overlayCanvas.style.top = video.offsetTop + 'px';

                const displaySize = { width: videoWidth, height: videoHeight };
                faceapi.matchDimensions(overlayCanvas, displaySize);

                let isProcessing = false;
                faceDetectionInterval = setInterval(async () => {
                    if (typeof faceapi !== 'undefined' && !isProcessing && stream) {
                        isProcessing = true;
                        try {
                            const detections = await faceapi.detectAllFaces(video, new faceapi.TinyFaceDetectorOptions({
                                inputSize: 224,
                                scoreThreshold: 0.3
                            }));

                            // Resize detections to match the real video size
                            const resizedDetections = faceapi.resizeResults(detections, displaySize);
                            const context = overlayCanvas.getContext('2d');
                            context.clearRect(0, 0, overlayCanvas.width, overlayCanvas.height);
                            faceapi.draw.drawDetections(overlayCanvas, resizedDetections);
                        } catch (detectionError) {
                            console.error('Error during face detection:', detectionError);
                        } finally {
                            isProcessing = false;
                        }
                    }
                }, 200);
            } catch (error) {
                console.error('Error starting face detection:', error);
            }
        }

        // دالة التقاط الصورة (لم يتم تعديلها في هذه الخطوة للتركيز على كشف الوجه)
        function capturePhoto() {
            const video = document.getElementById('camera-preview');
            const studentId = video.dataset.studentId;
            
            const canvas = document.createElement('canvas');
            
            // تحديد الأبعاد الجديدة مع الحفاظ على نسبة العرض إلى الارتفاع
            const maxWidth = 640; // Maximum desired width
            const scale = Math.min(maxWidth / video.videoWidth, 1);
            
            canvas.width = video.videoWidth * scale;
            canvas.height = video.videoHeight * scale;
            
            canvas.getContext('2d').drawImage(video, 0, 0, canvas.width, canvas.height);
            
            // تحويل الصورة إلى ملف بجودة أعلى (0.9 بدلاً من الافتراضي 0.8)
            canvas.toBlob(blob => {
                capturedPhotos.set(studentId, blob);
                updateCounter();
                closeCamera(); // ستغلق الكاميرا وتوقف كشف الوجه أيضاً
                updateTable();
            }, 'image/jpeg', 0.9);
        }
        
        // دالة تحديث العداد
        function updateCounter() {
            document.getElementById('photos-count').textContent = capturedPhotos.size;
        }
        
        // دالة تحميل الصور
        function downloadImages() {
            if (capturedPhotos.size === 0) {
                alert('لا توجد صور لتحميلها');
                return;
            }
            
            const zip = new JSZip();
            
            capturedPhotos.forEach((blob, studentId) => {
                zip.file(`${studentId}.jpg`, blob);
            });
            
            zip.generateAsync({ type: 'blob' })
                .then(content => {
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(content);
                    link.download = 'student_photos.zip';
                    link.click();
                });
        }
        
        // دالة البحث
        document.querySelector('.search-box').addEventListener('input', function(e) {
            const searchText = e.target.value.toLowerCase();
            const rows = document.querySelectorAll('#students-table tbody tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchText) ? '' : 'none';
            });
        });
    </script>
    <!-- إضافة مكتبة jszip لتحميل الصور كملف مضغوط -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>
</body>
</html> 